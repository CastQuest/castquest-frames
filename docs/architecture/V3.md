# CastQuest V3 Architecture

## Status
**V3 is stable but architecturally frozen.**

V3 represents the initial production deployment system with transparent fee management and multi-chain support. While stable and functional, V3 is feature-complete and will not receive new functionality. Security fixes and critical bug fixes may still be applied.

## What V3 Represents

CastQuest V3 is a comprehensive production deployment system that introduced:

### Smart Contracts (12 total)
- **Core Protocol Tokens**: CASTToken, MediaToken, MediaTokenFactory
- **Registry & Market**: MediaRegistry, MediaMarket, FeeRouter
- **V3 Enhancement Contracts**:
  - `QuestToken.sol` - ERC-721 quest completion rewards
  - `GameToken.sol` - ERC-721 game assets with leaderboards
  - `CodeToken.sol` - ERC-721 AI-generated code NFTs
  - `SponsorToken.sol` - ERC-20 creator sponsorship
  - `FeeManagerV3.sol` - Transparent fee collection and distribution
  - `Marketplace.sol` - Unified NFT marketplace
  - `GovernanceV2.sol` - DAO governance with timelocks

### Fee Structure
- **Transparent Fees**: 5% total (2.5% protocol + 0.5% developer + 2.0% DAO)
- **Governance-Controlled**: 48-hour timelock, adjustable via DAO vote
- **On-Chain Distribution**: Automated fee splitting via FeeManagerV3

### Deployment Infrastructure
- Multi-chain deployment scripts (Base, Optimism)
- Automated ABI extraction to SDK
- CI/CD pipeline with GitHub Actions
- Type-safe contract address management

### Documentation
- Complete fee structure documentation
- Deployment guides for testnet and mainnet
- API reference with integration examples
- Implementation summary and statistics

## What Problems V3 Solved

1. **Fee Transparency**: Introduced transparent, on-chain fee management with clear documentation
2. **Governance**: Added DAO-controlled fee adjustments with timelock safety
3. **Multi-Chain Support**: Infrastructure for deploying across Base, Optimism, and other EVM chains
4. **Developer Experience**: Type-safe SDK, automated ABI extraction, comprehensive docs
5. **Security**: Addressed critical vulnerabilities (ERC-20 marketplace exploit, fee routing bugs)

## Why V4 Exists

V3 was built with certain architectural assumptions that limit its evolution:

### V3 Limitations
- **Token Architecture**: Quest/Game/Code tokens are ERC-721 NFTs, not part of core tokenomics
- **No Bonding Curves**: Static pricing, no automated market making for system tokens
- **Limited SubDAO Model**: No native per-user SubDAO registry or reputation system
- **OpenZeppelin Dependencies**: Relies on OZ for access control and token standards
- **Complex Fee Routing**: Multiple fee collection points with manual distribution steps

### V4 Goals
- **Unified Tokenomics**: Fixed-supply core tokens (CAST, QUEST, GXQS) with clear caps
- **Bonding Curves**: Automated pricing for system tokens (MEDIA, FRAME, GAME, CODE, AGENT)
- **Native SubDAO**: Every user is a SubDAO with on-chain reputation and rewards
- **Clean Architecture**: No OZ dependencies, simplified contracts, single SupplyGovernor
- **Automated Economics**: BuybackEngine, Treasury routing, integrated fee flows

## V3 Architecture Overview

```
┌─────────────────┐
│   CASTToken     │ ← Core protocol token
└────────┬────────┘
         │
┌────────▼────────┐
│ MediaRegistry   │ ← Tracks media, risk flags
└────────┬────────┘
         │
┌────────▼──────────┐
│MediaTokenFactory  │ ← Creates per-media ERC-20 tokens
└────────┬──────────┘
         │
┌────────▼────────┐
│  MediaMarket    │ ← AMM for media tokens
└────────┬────────┘
         │
┌────────▼────────┐
│  FeeRouter      │ ← Routes fees to treasury/CAST
└─────────────────┘

V3 Enhancements:
┌──────────────┐
│ FeeManagerV3 │ ← Transparent fee collection & distribution
└──────────────┘
┌──────────────┐
│ Marketplace  │ ← Unified NFT marketplace (V3)
└──────────────┘
┌──────────────┐
│GovernanceV2  │ ← DAO governance with timelocks
└──────────────┘
```

## Key Contracts Reference

| Contract | Purpose | Status |
|----------|---------|--------|
| CASTToken | Core protocol token | Stable |
| MediaToken | Per-media ERC-20 tokens | Stable |
| MediaTokenFactory | Token creation | Stable |
| MediaRegistry | Media tracking | Stable |
| MediaMarket | Trading AMM | Stable |
| FeeRouter | Legacy fee routing | Stable |
| QuestToken | Quest NFTs | V3 Feature-complete |
| GameToken | Game NFTs | V3 Feature-complete |
| CodeToken | Code NFTs | V3 Feature-complete |
| SponsorToken | Sponsorship ERC-20 | V3 Feature-complete |
| FeeManagerV3 | Fee management | V3 Feature-complete |
| Marketplace | NFT marketplace | V3 Feature-complete |
| GovernanceV2 | DAO governance | V3 Feature-complete |

## Migration Path

V3 contracts will remain deployed and operational. V4 introduces a parallel system:

1. V3 contracts continue serving existing users
2. V4 launches with new tokenomics and architecture
3. Migration tools (TBD) may allow users to bridge value from V3 to V4
4. No forced migration - users choose when to adopt V4

## Support Policy

- **Security Fixes**: Critical security issues will be patched
- **Bug Fixes**: Critical bugs may be fixed if they impact users
- **New Features**: No new features will be added to V3
- **Documentation**: Maintained as reference for V4 development

## References

- [Fee Structure Documentation](../FEE_STRUCTURE.md)
- [Deployment Guide](../DEPLOYMENT_GUIDE_V3.md)
- [API Reference](../API_REFERENCE_V3.md)
- [Implementation Summary](../V3_IMPLEMENTATION_SUMMARY.md)

---

**For new development, see [V4 Architecture](./V4.md)**
