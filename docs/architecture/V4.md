# CastQuest V4 Architecture

## Status
**V4 is a clean-slate redesign.**

V3 remains stable and supported, but no new features land there. V4 represents a fundamental rethinking of CastQuest's tokenomics, governance, and economic model.

## Core Principles

### 1. Base-First
V4 is built exclusively for **Base** as the home chain:
- Low gas fees for creators
- Base ecosystem (Frames, Zora, Farcaster)
- Coinbase onboarding
- Fast finality

### 2. Fixed-Supply Core Tokens
V4 introduces three capped protocol tokens:

| Token | Max Supply | Purpose |
|-------|-----------|---------|
| CAST | 44,000,000 | Core protocol token |
| QUEST | 888,000,000 | Activity & quest rewards |
| GXQS | 22,000,000 | DAO governance |

**Invariants:**
- No minting beyond caps (enforced on-chain)
- Only SupplyGovernor can mint
- GXQS DAO owns SupplyGovernor
- CAST fully minted at deployment

### 3. Uncapped System Tokens
Five vertical-specific tokens with no supply caps:

- **MEDIA** - Media creation and rewards
- **FRAME** - Frame-related actions
- **GAME** - Game asset economics
- **CODE** - Code generation rewards for autonomous builders and AI agents
- **AGENT** - AI agent operations

These are minted by their respective Engines and used for fees, rewards, and liquidity.

### 4. No External Dependencies
- **No OpenZeppelin imports** - Custom ERC-20 implementation
- **No proxies** - Immutable contracts
- **No delegatecall** - Direct calls only
- **No unchecked math** - All operations checked
- **No external calls in mint** - Pure token operations

### 5. SubDAO-First Model
Every user is a SubDAO:
- Handle: `@username`
- On-chain registry in SubDAORegistry
- Accumulates reputation from all creative actions
- Tracks total market cap of all tokens launched
- Can create micro-tokens for individual creations

## V4 Architecture

```
┌─────────────────────────────────────────────────────┐
│                   Core Tokenomics                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │   CAST   │  │  QUEST   │  │   GXQS   │          │
│  │44M fixed │  │888M cap  │  │22M fixed │          │
│  └─────┬────┘  └─────┬────┘  └─────┬────┘          │
│        │             │              │                │
│        └─────────────┴──────────────┘                │
│                      │                               │
│            ┌─────────▼─────────┐                     │
│            │  SupplyGovernor   │ ← Exclusive minting │
│            └─────────┬─────────┘                     │
│                      │                               │
│            ┌─────────▼─────────┐                     │
│            │   GXQS DAO        │ ← Owns governor     │
│            │   Governance      │                     │
│            └───────────────────┘                     │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│                 Vertical Engines                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │  MEDIA   │  │  FRAME   │  │   GAME   │          │
│  │ uncapped │  │ uncapped │  │ uncapped │          │
│  └─────┬────┘  └─────┬────┘  └─────┬────┘          │
│        │             │              │                │
│  ┌─────▼─────┐ ┌────▼──────┐ ┌────▼──────┐         │
│  │MediaEngine│ │FrameEngine│ │GameEngine │         │
│  └─────┬─────┘ └────┬──────┘ └────┬──────┘         │
│        │            │             │                  │
│  ┌─────▼─────┐ ┌───▼───────┐ ┌───▼───────┐         │
│  │MediaLaunch│ │FrameLaunch│ │GameLaunch │         │
│  │  Router   │ │  Router   │ │  Router   │         │
│  └─────┬─────┘ └────┬──────┘ └────┬──────┘         │
│        └────────────┴─────────────┘                 │
│                     │                                │
└─────────────────────┼────────────────────────────────┘
                      │
┌─────────────────────▼────────────────────────────────┐
│                Economic Flow                          │
│            ┌─────────────┐                           │
│            │  FeeRouter  │ ← Collects all fees       │
│            └──────┬──────┘                           │
│                   │                                   │
│         ┌─────────┴─────────┐                        │
│         │                   │                        │
│  ┌──────▼──────┐    ┌──────▼──────┐                 │
│  │BuybackEngine│    │  Treasury   │                  │
│  │             │    │0x7B861609...│                  │
│  └─────────────┘    └─────────────┘                  │
└──────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────┐
│                  SubDAO Registry                      │
│  ┌──────────────────────────────────────────────┐   │
│  │   Every User = SubDAO                        │   │
│  │   - @vitalik → SubDAO entry                  │   │
│  │   - Reputation tracker                       │   │
│  │   - Reward accumulator                       │   │
│  │   - Token launch history                     │   │
│  └──────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────┘
```

## Contract Hierarchy

### Phase 1: Core Primitives (Foundation)
```
ERC20Base.sol          ← Custom ERC-20 (no OZ)
├── CASTToken.sol      ← 44M fixed supply
├── QUESTToken.sol     ← 888M cap
├── GXQSToken.sol      ← 22M fixed supply
└── SupplyGovernor.sol ← Exclusive minter, enforces caps
```

**Invariants (Phase 1.5):**
- Supply caps enforced on-chain
- Only SupplyGovernor can mint
- No external calls in token operations
- No reentrancy in mint/burn
- All standard ERC-20 events emitted

### Phase 2: Governance Layer
```
GovernanceV4.sol       ← DAO governance
├── Proposal system    ← Create, vote, execute
├── Timelock           ← 48-hour delay
└── Ownership transfer ← SupplyGovernor ownership
```

### Phase 3: Economic Routing
```
FeeRouter.sol          ← Central fee collection
├── BuybackEngine.sol  ← CAST buybacks
└── Treasury.sol       ← Protocol treasury (0x7B861609...)
```

### Phase 4: Engines & System Tokens
```
System Tokens:
├── MEDIAToken.sol     ← Uncapped
├── FRAMEToken.sol     ← Uncapped
├── GAMEToken.sol      ← Uncapped
├── CODEToken.sol      ← Uncapped
└── AGENTToken.sol     ← Uncapped

Engines:
├── MediaEngine.sol    ← Mints MEDIA, creates media assets
├── FrameEngine.sol    ← Mints FRAME, processes frames
├── GameEngine.sol     ← Mints GAME, handles game logic
├── CodeEngine.sol     ← Mints CODE, manages autonomous code generation, audits, and agentic incentives
└── AgentEngine.sol    ← Mints AGENT, AI operations
```

### Phase 5: Launch Routers
```
LaunchRouters:
├── MediaLaunchRouter.sol    ← Media creation flow
├── FrameLaunchRouter.sol    ← Frame posting flow
├── GameLaunchRouter.sol     ← Game deployment flow
├── CodeLaunchRouter.sol     ← Code generation flow
└── AgentLaunchRouter.sol    ← Agent spawning flow
```

### Phase 6: SubDAO & Integration
```
SubDAORegistry.sol     ← User registry
├── User profiles      ← @username mapping
├── Reputation system  ← Activity tracking
└── Reward tracking    ← Token accumulation
```

## Bonding Curve Integration

System tokens (MEDIA, FRAME, GAME, CODE, AGENT) use bonding curves:

```
Price = BasePrice + (Supply × Slope)

Features:
- Early buyers get cheaper tokens
- Price increases with supply
- Liquidity locked (no rug)
- No central price control
```

Implementation in Engines:
- Each Engine implements bonding curve pricing
- Mint operations adjust price automatically
- Fees flow through FeeRouter
- Buybacks create price floor

## Data Flow Example: Media Creation

```
1. User posts media via MediaLaunchRouter
   ↓
2. MediaLaunchRouter validates and routes
   ↓
3. MediaEngine:
   - Mints MEDIA tokens (bonding curve price)
   - Creates ERC-721 asset for media
   - Registers in SubDAORegistry
   ↓
4. Fees collected → FeeRouter
   ↓
5. FeeRouter splits:
   - X% → BuybackEngine (CAST buyback)
   - Y% → Treasury (protocol ops)
   - Z% → Creator (SubDAO reward)
   ↓
6. SubDAO reputation updated
7. User micro-token optional mint
```

## Migration from V3

V3 and V4 coexist:
- V3 contracts remain operational
- V4 launches as parallel system
- No forced migration
- Bridge contracts (future) may enable value transfer

Users choose when to adopt V4 based on:
- New tokenomics benefits
- Bonding curve opportunities
- SubDAO features
- Lower gas costs on Base

## Agentic Development Integration

V4's Smart Brain architecture integrates with agentic development frameworks to enable:
- **Autonomous Protocol Expansion**: AI agents (e.g., castquest-code from SMSDAO) can propose and scaffold new protocol features
- **Automated Contract Generation**: CodeEngine coordinates with development agents to generate, audit, and deploy smart contracts
- **CODE Token Rewards**: Validated contributions from AI-powered development tools, agentic protocol expansion, and automated smart contract generation are rewarded with CODE tokens
- **Continuous Evolution**: The protocol evolves through a combination of human governance and AI-assisted development

This creates a flywheel where protocol improvements are incentivized through CODE tokens, enabling sustainable, community-driven growth.

## Security Guarantees

1. **Supply Caps**: Enforced on-chain, cannot be bypassed
2. **Governance Control**: All critical params controlled by GXQS DAO
3. **No Proxies**: Immutable contracts, what you see is what you get
4. **No External Calls**: Token operations are pure, no reentrancy
5. **Timelock Protection**: 48-hour delay on governance changes

## Treasury Address

**Production Treasury**: `0x7B861609F4f5977997A6478B09d81A7256d6c748`

All protocol fees, buybacks, and reserves flow through this address.

## Development Phases

- [ ] **Phase 0**: Skeleton structure (contracts-v4 folder, build config)
- [ ] **Phase 1**: Core primitives (ERC20Base, CAST, QUEST, GXQS, SupplyGovernor)
- [ ] **Phase 1.5**: Invariant lock (formalize and test all invariants)
- [ ] **Phase 2**: Governance layer (GovernanceV4, timelocks)
- [ ] **Phase 3**: Economic routing (FeeRouter, BuybackEngine, Treasury)
- [ ] **Phase 4**: Engines & system tokens (5 engines + 5 tokens)
- [ ] **Phase 5**: Launch routers (5 routers + integration)
- [ ] **Phase 6**: SubDAO & UI (registry, frontend, SDK)

## References

- [V3 Architecture](./V3.md) - Previous stable architecture
- Treasury address: `0x7B861609F4f5977997A6478B09d81A7256d6c748`
- Chain: Base (chain ID 8453)

---

**V4 is in active development. V3 remains stable for production use.**
