name: Dependency Health Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  dependency-health:
    name: Check Repository Health
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
      
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: Validate package.json files
        id: validate-json
        run: |
          echo "## Package.json Validation" >> $GITHUB_STEP_SUMMARY
          INVALID=0
          while IFS= read -r -d '' file; do
            if ! jq empty "$file" 2>/dev/null; then
              echo "‚ùå Invalid JSON: $file" >> $GITHUB_STEP_SUMMARY
              INVALID=$((INVALID + 1))
            fi
          done < <(find . -name "package.json" -not -path "*/node_modules/*" -print0)
          
          if [ $INVALID -eq 0 ]; then
            echo "‚úÖ All package.json files are valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Found $INVALID invalid package.json files" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      
      - name: Check dependency version consistency
        id: check-versions
        run: |
          echo "## Dependency Version Consistency" >> $GITHUB_STEP_SUMMARY
          
          # Check TypeScript versions
          echo "### TypeScript Versions" >> $GITHUB_STEP_SUMMARY
          TS_VERSIONS=$(find . -name "package.json" -not -path "*/node_modules/*" -exec jq -r '.devDependencies.typescript // .dependencies.typescript // empty' {} \; | sort -u)
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "$TS_VERSIONS" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          TS_COUNT=$(echo "$TS_VERSIONS" | grep -v '^$' | wc -l)
          if [ $TS_COUNT -gt 1 ]; then
            echo "‚ö†Ô∏è Multiple TypeScript versions detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ TypeScript version is consistent" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check @types/node versions
          echo "### @types/node Versions" >> $GITHUB_STEP_SUMMARY
          NODE_VERSIONS=$(find . -name "package.json" -not -path "*/node_modules/*" -exec jq -r '.devDependencies["@types/node"] // .dependencies["@types/node"] // empty' {} \; | sort -u)
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "$NODE_VERSIONS" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          NODE_COUNT=$(echo "$NODE_VERSIONS" | grep -v '^$' | wc -l)
          if [ $NODE_COUNT -gt 1 ]; then
            echo "‚ö†Ô∏è Multiple @types/node versions detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ @types/node version is consistent" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Verify workspace links
        run: |
          echo "## Workspace Dependencies" >> $GITHUB_STEP_SUMMARY
          if [ -d "apps/web/node_modules/@castquest/neo-ux-core" ] || [ -L "apps/web/node_modules/@castquest/neo-ux-core" ]; then
            echo "‚úÖ Workspace links are properly configured" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Workspace links are not properly configured" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      
      - name: Run build tests
        id: build-tests
        run: |
          echo "## Build Tests" >> $GITHUB_STEP_SUMMARY
          
          # Build packages in order
          PACKAGES=("packages/neo-ux-core" "packages/sdk")
          BUILD_FAILURES=0
          
          for pkg in "${PACKAGES[@]}"; do
            if [ -f "$pkg/package.json" ]; then
              echo "Building $pkg..." >> $GITHUB_STEP_SUMMARY
              if (cd "$pkg" && pnpm build); then
                echo "‚úÖ $pkg built successfully" >> $GITHUB_STEP_SUMMARY
              else
                echo "‚ùå Failed to build $pkg" >> $GITHUB_STEP_SUMMARY
                BUILD_FAILURES=$((BUILD_FAILURES + 1))
              fi
            fi
          done
          
          if [ $BUILD_FAILURES -gt 0 ]; then
            echo "‚ùå $BUILD_FAILURES packages failed to build" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "‚úÖ All packages built successfully" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Security audit
        id: security-audit
        run: |
          echo "## Security Audit" >> $GITHUB_STEP_SUMMARY
          
          # Run pnpm audit and capture output
          if pnpm audit --json > audit-output.json 2>&1; then
            echo "‚úÖ No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            # Parse audit output
            if [ -f audit-output.json ]; then
              CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' audit-output.json 2>/dev/null || echo "0")
              HIGH=$(jq -r '.metadata.vulnerabilities.high // 0' audit-output.json 2>/dev/null || echo "0")
              MODERATE=$(jq -r '.metadata.vulnerabilities.moderate // 0' audit-output.json 2>/dev/null || echo "0")
              
              echo "- Critical: $CRITICAL" >> $GITHUB_STEP_SUMMARY
              echo "- High: $HIGH" >> $GITHUB_STEP_SUMMARY
              echo "- Moderate: $MODERATE" >> $GITHUB_STEP_SUMMARY
              
              if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
                echo "‚ö†Ô∏è Security vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
                echo "Run \`pnpm audit --fix\` to resolve" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi
          
          rm -f audit-output.json
        continue-on-error: true
      
      - name: Check documentation links
        id: check-docs
        run: |
          echo "## Documentation Links" >> $GITHUB_STEP_SUMMARY
          
          REQUIRED_DOCS=("README.md" "CONTRIBUTING.md" "docs/DASHBOARDS.md" "docs/README.md")
          MISSING=0
          
          for doc in "${REQUIRED_DOCS[@]}"; do
            if [ -f "$doc" ]; then
              echo "‚úÖ $doc exists" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå $doc is missing" >> $GITHUB_STEP_SUMMARY
              MISSING=$((MISSING + 1))
            fi
          done
          
          if [ $MISSING -eq 0 ]; then
            echo "‚úÖ All required documentation exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è $MISSING documentation files are missing" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Run comprehensive health check
        id: health-check
        run: |
          chmod +x scripts/master.sh
          ./scripts/master.sh health
        continue-on-error: true
      
      - name: Run Smart Brain Oracle
        id: oracle
        run: |
          chmod +x .smartbrain/oracle.sh
          .smartbrain/oracle.sh report
        continue-on-error: true
      
      - name: Upload Oracle Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: oracle-report
          path: ORACLE-REPORT.md
          retention-days: 30
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let comment = '## üè• Dependency Health Check Report\n\n';
            
            try {
              const summary = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8');
              comment += summary;
            } catch (error) {
              comment += '‚ö†Ô∏è Could not generate detailed report\n';
            }
            
            comment += '\n\n---\n';
            comment += 'üìä **Full Analysis**: Check the workflow run for complete details\n';
            comment += 'üîç **Oracle Report**: Available in workflow artifacts\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Create issue for failures
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'üö® Dependency Health Check Failed';
            const body = `
            ## Dependency Health Check Failure
            
            The scheduled dependency health check has detected issues that require attention.
            
            **Workflow Run**: ${context.payload.repository.html_url}/actions/runs/${context.runId}
            **Date**: ${new Date().toISOString()}
            
            ### Actions Required
            
            1. Review the workflow run for detailed error messages
            2. Check the Oracle report in artifacts
            3. Run \`./scripts/repair-dependencies.sh health\` locally
            4. Run \`./scripts/repair-dependencies.sh repair\` to fix issues
            
            ### Common Fixes
            
            - Update dependency versions: \`pnpm update\`
            - Fix security issues: \`pnpm audit --fix\`
            - Rebuild packages: \`pnpm -r build\`
            - Harmonize versions: \`./scripts/repair-dependencies.sh harmonize\`
            
            ---
            *This issue was automatically created by the Dependency Health Check workflow*
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['dependencies', 'automated', 'health-check']
            });
