#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# CastQuest Frames - Pre-commit Hook
# Validates changes before allowing commit

echo "ğŸ” Running pre-commit checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

ROOT_DIR="$(git rev-parse --show-toplevel)"
cd "$ROOT_DIR"

CHECKS_PASSED=0
CHECKS_FAILED=0

# Check if jq is available
if ! command -v jq &> /dev/null; then
  echo "${YELLOW}âš  jq not found, skipping JSON validation${NC}"
else
  # 1. Validate package.json changes
  echo "ğŸ“¦ Validating package.json files..."
  CHANGED_PACKAGE_JSON=$(git diff --cached --name-only | grep "package.json" || true)
  
  if [ -n "$CHANGED_PACKAGE_JSON" ]; then
    INVALID=0
    for file in $CHANGED_PACKAGE_JSON; do
      if [ -f "$file" ]; then
        if ! jq empty "$file" 2>/dev/null; then
          echo "${RED}âœ— Invalid JSON: $file${NC}"
          INVALID=$((INVALID + 1))
        fi
      fi
    done
    
    if [ $INVALID -eq 0 ]; then
      echo "${GREEN}âœ“ All package.json files are valid${NC}"
      CHECKS_PASSED=$((CHECKS_PASSED + 1))
    else
      echo "${RED}âœ— Found $INVALID invalid package.json files${NC}"
      CHECKS_FAILED=$((CHECKS_FAILED + 1))
    fi
  else
    echo "${GREEN}âœ“ No package.json files changed${NC}"
    CHECKS_PASSED=$((CHECKS_PASSED + 1))
  fi
fi

# 2. Check workspace dependency references
echo "ğŸ”— Checking workspace dependency references..."
CHANGED_PACKAGE_JSON=$(git diff --cached --name-only | grep "package.json" || true)

if [ -n "$CHANGED_PACKAGE_JSON" ] && command -v jq &> /dev/null; then
  INVALID_REFS=0
  for file in $CHANGED_PACKAGE_JSON; do
    if [ -f "$file" ]; then
      # Check for workspace dependencies using incorrect syntax
      WORKSPACE_DEPS=$(jq -r '.dependencies, .devDependencies | to_entries[] | select(.key | startswith("@castquest/")) | select(.value | startswith("workspace:") | not) | .key + ": " + .value' "$file" 2>/dev/null || true)
      
      if [ -n "$WORKSPACE_DEPS" ]; then
        echo "${YELLOW}âš  Non-workspace references in $file:${NC}"
        echo "$WORKSPACE_DEPS"
        INVALID_REFS=$((INVALID_REFS + 1))
      fi
    fi
  done
  
  if [ $INVALID_REFS -eq 0 ]; then
    echo "${GREEN}âœ“ Workspace dependencies are correctly referenced${NC}"
    CHECKS_PASSED=$((CHECKS_PASSED + 1))
  else
    echo "${YELLOW}âš  Found $INVALID_REFS files with non-workspace references${NC}"
    echo "${YELLOW}  Use 'workspace:*' for internal dependencies${NC}"
    CHECKS_PASSED=$((CHECKS_PASSED + 1))  # Don't fail on this, just warn
  fi
else
  echo "${GREEN}âœ“ No package.json changes to check${NC}"
  CHECKS_PASSED=$((CHECKS_PASSED + 1))
fi

# 3. Verify TypeScript configurations
echo "ğŸ“˜ Checking TypeScript configuration..."
CHANGED_TS_CONFIG=$(git diff --cached --name-only | grep "tsconfig.json" || true)

if [ -n "$CHANGED_TS_CONFIG" ] && command -v jq &> /dev/null; then
  INVALID_TS=0
  for file in $CHANGED_TS_CONFIG; do
    if [ -f "$file" ]; then
      # Validate JSON
      if ! jq empty "$file" 2>/dev/null; then
        echo "${RED}âœ— Invalid JSON in tsconfig: $file${NC}"
        INVALID_TS=$((INVALID_TS + 1))
      fi
    fi
  done
  
  if [ $INVALID_TS -eq 0 ]; then
    echo "${GREEN}âœ“ TypeScript configurations are valid${NC}"
    CHECKS_PASSED=$((CHECKS_PASSED + 1))
  else
    echo "${RED}âœ— Found $INVALID_TS invalid TypeScript configurations${NC}"
    CHECKS_FAILED=$((CHECKS_FAILED + 1))
  fi
else
  echo "${GREEN}âœ“ No TypeScript config changes${NC}"
  CHECKS_PASSED=$((CHECKS_PASSED + 1))
fi

# 4. Run lint on changed files (if available)
echo "ğŸ¨ Running linters on changed files..."
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ -n "$CHANGED_FILES" ]; then
  if command -v pnpm &> /dev/null; then
    # Only lint if there are staged TypeScript/JavaScript files
    if pnpm lint --fix 2>/dev/null; then
      echo "${GREEN}âœ“ Linting passed${NC}"
      CHECKS_PASSED=$((CHECKS_PASSED + 1))
      
      # Re-stage files that were auto-fixed
      printf '%s\n' "$CHANGED_FILES" | while IFS= read -r file; do
        [ -n "$file" ] && git add -- "$file" 2>/dev/null || true
      done
    else
      echo "${YELLOW}âš  Linting issues detected (non-blocking)${NC}"
      CHECKS_PASSED=$((CHECKS_PASSED + 1))
    fi
  else
    echo "${YELLOW}âš  pnpm not available, skipping lint${NC}"
    CHECKS_PASSED=$((CHECKS_PASSED + 1))
  fi
else
  echo "${GREEN}âœ“ No TypeScript/JavaScript files changed${NC}"
  CHECKS_PASSED=$((CHECKS_PASSED + 1))
fi

# 5. Prevent commits with broken dependencies (basic check)
echo "ğŸ” Checking for dependency issues..."
if [ -f "pnpm-lock.yaml" ]; then
  # Check if pnpm-lock.yaml changed but package.json didn't (or vice versa)
  LOCK_CHANGED=$(git diff --cached --name-only | grep "pnpm-lock.yaml" || true)
  PKG_JSON_CHANGED=$(git diff --cached --name-only | grep "package.json" || true)
  
  if [ -n "$LOCK_CHANGED" ] && [ -z "$PKG_JSON_CHANGED" ]; then
    echo "${YELLOW}âš  pnpm-lock.yaml changed without package.json changes${NC}"
    echo "${YELLOW}  This might be intentional, but verify dependencies are correct${NC}"
  fi
  
  echo "${GREEN}âœ“ Dependency check complete${NC}"
  CHECKS_PASSED=$((CHECKS_PASSED + 1))
else
  echo "${GREEN}âœ“ No pnpm-lock.yaml changes${NC}"
  CHECKS_PASSED=$((CHECKS_PASSED + 1))
fi

# Summary
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Pre-commit Check Summary"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Passed: $CHECKS_PASSED"
echo "Failed: $CHECKS_FAILED"

if [ $CHECKS_FAILED -eq 0 ]; then
  echo "${GREEN}âœ… All checks passed - proceeding with commit${NC}"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  exit 0
else
  echo "${RED}âŒ Some checks failed - commit blocked${NC}"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "To bypass this check (not recommended):"
  echo "  git commit --no-verify"
  echo ""
  exit 1
fi
